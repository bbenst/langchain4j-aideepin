# 用户侧接口-业务流程概览

本文档面向用户侧（`adi-chat` + `adi-common`），以“时序/步骤”的方式概览主要业务流程。

## 认证与账号
1. 注册
- 触发：`POST /auth/register`
- 处理：校验注册信息 → 写入用户与待激活记录 → 发送激活邮件
- 结果：返回“激活链接已发送”

2. 注册验证码
- 触发：`GET /auth/register/captcha`
- 处理：生成验证码 → 缓存验证码 → 输出验证码图片
- 结果：浏览器拿到验证码图片

3. 激活
- 触发：`GET /auth/active?code=...`
- 处理：校验激活码 → 激活用户
- 结果：重定向到前端激活结果页

4. 登录
- 触发：`POST /auth/login`
- 处理：校验验证码与账号密码 → 生成 Token
- 结果：返回登录信息，并写入 `Authorization` 响应头与 Cookie

5. 登录验证码
- 触发：`GET /auth/login/captcha`
- 处理：生成验证码 → 缓存 → 输出图片
- 结果：浏览器拿到验证码图片

6. 忘记密码
- 触发：`POST /auth/password/forgot`
- 处理：生成重置链接 → 发送邮件
- 结果：返回“重置密码链接已发送”

7. 重置密码
- 触发：`GET /auth/password/reset?code=...`
- 处理：校验重置码 → 重置密码
- 结果：重定向到前端提示页

8. 用户登出
- 触发：`POST /user/logout`
- 处理：清理登录态/Token
- 结果：登出成功

## 用户配置与头像
1. 获取用户配置
- 触发：`GET /user/config`
- 处理：读取当前用户配置
- 结果：返回配置

2. 修改用户配置
- 触发：`POST /user/edit`
- 处理：更新用户配置项
- 结果：配置更新完成

3. 修改密码
- 触发：`POST /user/password/modify`
- 处理：校验旧密码 → 更新新密码
- 结果：返回“修改成功”

4. 头像获取
- 触发：`GET /user/myAvatar` / `GET /user/avatar/{uuid}`
- 处理：生成或读取头像 → 输出图片
- 结果：返回头像图片

## 会话与消息（聊天）
1. 创建会话
- 触发：`POST /conversation/add`
- 处理：保存会话基本信息
- 结果：返回会话信息

2. 由预设创建会话
- 触发：`POST /conversation/addByPreset`
- 处理：基于预设复制会话配置
- 结果：返回新会话

3. 会话列表
- 触发：`GET /conversation/list`
- 处理：按当前用户查询
- 结果：返回会话列表

4. 会话详情/消息分页
- 触发：`GET /conversation/{uuid}`
- 处理：查询会话及消息分页
- 结果：返回会话消息列表

5. 发送消息（SSE）
- 触发：`POST /conversation/message/process`
- 处理：
- 业务校验（会话状态/配额等）
- RAG 检索与上下文准备
- 调用 LLM 生成
- 消息与引用落库
- 结果：SSE 流式响应最终答案

6. 消息引用查询
- 触发：`GET /conversation/message/embedding-ref/{uuid}`
- 处理：查询向量引用
- 结果：返回引用列表
- 触发：`GET /conversation/message/graph-ref/{uuid}`
- 处理：查询图谱引用
- 结果：返回引用图

7. 删除会话/消息
- 触发：`POST /conversation/del/{uuid}` / `POST /conversation/message/del/{uuid}`
- 处理：软删除
- 结果：删除完成

8. 音频转文本查询
- 触发：`GET /conversation/message/text/{audioUuid}`
- 处理：读取识别结果
- 结果：返回文本

## 知识库（RAG）
1. 新建/更新知识库
- 触发：`POST /knowledge-base/saveOrUpdate`
- 处理：保存知识库配置
- 结果：返回知识库信息

2. 上传文档并索引
- 触发：`POST /knowledge-base/upload/{uuid}` 或 `/uploadDocs/{uuid}`
- 处理：上传 → 解析 → 可选触发索引
- 结果：返回上传结果或文件信息

3. 索引整个知识库
- 触发：`POST /knowledge-base/indexing/{uuid}`
- 处理：批量索引文档
- 结果：索引任务提交

4. 索引知识点
- 触发：`POST /knowledge-base/item/indexing-list`
- 处理：批量索引指定条目
- 结果：索引完成

5. 检查索引状态
- 触发：`GET /knowledge-base/indexing/check`
- 处理：检查索引是否结束
- 结果：返回布尔值

6. 知识库查询
- 触发：`GET /knowledge-base/mine/search` / `/public/search`
- 处理：按条件分页查询
- 结果：返回列表

7. 知识库详情/删除/收藏
- 触发：`GET /knowledge-base/info/{uuid}`
- 处理：查询详情
- 结果：返回详情
- 触发：`POST /knowledge-base/del/{uuid}`
- 处理：软删除
- 结果：删除完成
- 触发：`POST /knowledge-base/star/toggle`
- 处理：点赞/取消点赞
- 结果：返回操作结果

## 知识库问答（SSE）
1. 提问记录创建
- 触发：`POST /knowledge-base/qa/add/{kbUuid}`
- 处理：创建问答记录
- 结果：返回问答记录

2. 生成回答（SSE）
- 触发：`POST /knowledge-base/qa/process/{qaRecordUuid}`
- 处理：RAG 检索 → LLM 生成 → 引用落库
- 结果：SSE 流式返回答案

3. 问答记录查询/删除
- 触发：`GET /knowledge-base/qa/search`
- 处理：分页查询
- 结果：返回列表
- 触发：`POST /knowledge-base/qa/del/{uuid}`
- 处理：软删除
- 结果：删除完成
- 触发：`POST /knowledge-base/qa/clear`
- 处理：清空当前用户记录
- 结果：清空完成

4. 问答引用
- 触发：`GET /knowledge-base/qa/embedding-ref/{uuid}`
- 处理：查询向量引用
- 结果：返回引用
- 触发：`GET /knowledge-base/qa/graph-ref/{uuid}`
- 处理：查询图谱引用
- 结果：返回引用图

## 绘图（文生图/图生图/修图/公开）
1. 创建绘图任务
- 触发：`POST /draw/generation`
- 处理：生成绘图任务并入库
- 结果：返回任务 UUID

2. 编辑/变体
- 触发：`POST /draw/edit` / `POST /draw/variation`
- 处理：基于输入图片生成新任务
- 结果：返回任务 UUID

3. 重新生成
- 触发：`POST /draw/regenerate/{uuid}`
- 处理：重新触发任务生成
- 结果：任务更新

4. 列表与详情
- 触发：`GET /draw/list`
- 处理：按用户分页查询
- 结果：返回列表
- 触发：`GET /draw/detail/{uuid}`
- 处理：查询详情
- 结果：返回详情

5. 公开与公共浏览
- 触发：`POST /draw/set-public/{uuid}`
- 处理：设置公开/私有及水印
- 结果：返回更新后的任务
- 触发：`GET /draw/public/list`
- 处理：查询公开列表
- 结果：返回列表
- 触发：`GET /draw/public/image/{drawUuid}/{imageUuidWithExt}`
- 处理：读取公开图片（可能含水印）
- 结果：返回图片

6. 删除与文件删除
- 触发：`POST /draw/del/{uuid}`
- 处理：软删除任务
- 结果：删除完成
- 触发：`POST /draw/file/del/{fileUuid}`
- 处理：删除生成图片文件
- 结果：删除完成

## AI 搜索（SSE）
1. 发起搜索
- 触发：`POST /ai-search/process`
- 处理：调用搜索引擎服务 → LLM 汇总
- 结果：SSE 流式返回答案

## 工作流
1. 工作流创建/复制/更新/启用
- 触发：`POST /workflow/add` / `/copy/{wfUuid}` / `/update` / `/enable/{uuid}`
- 处理：保存工作流与节点配置
- 结果：返回工作流信息或更新完成

2. 工作流运行（SSE）
- 触发：`POST /workflow/run/{wfUuid}`
- 处理：
- 生成运行实例
- 构建状态图与节点执行
- SSE 流式输出
- 若出现“人机交互节点”，中断并等待用户反馈
- 结果：
- 完成：输出最终结果
- 中断：返回等待输入提示

3. 工作流恢复执行
- 触发：`POST /workflow/runtime/resume/{runtimeUuid}`
- 处理：注入用户反馈 → 继续执行
- 结果：流程继续直至完成或再次中断

4. 工作流运行记录
- 触发：`GET /workflow/runtime/page`
- 处理：分页查询运行实例
- 结果：返回列表
- 触发：`GET /workflow/runtime/nodes/{runtimeUuid}`
- 处理：查询运行节点明细
- 结果：返回节点列表
- 触发：`POST /workflow/runtime/clear` / `/del/{wfRuntimeUuid}`
- 处理：清理或软删除运行记录
- 结果：删除完成

5. 工作流搜索与公开
- 触发：`GET /workflow/mine/search` / `/public/search`
- 处理：按条件分页查询
- 结果：返回列表
- 触发：`GET /workflow/public/component/list`
- 处理：返回可用组件
- 结果：组件列表
- 触发：`GET /workflow/public/operators`
- 处理：返回条件操作符
- 结果：操作符列表

## 文件与系统配置
1. 文件上传
- 触发：`POST /file/upload` / `/image/upload`
- 处理：保存文件 → 返回 URL
- 结果：返回文件 UUID 与 URL

2. 文件访问
- 触发：`GET /file/{uuidWithExt}`
- 处理：根据文件类型返回二进制
- 结果：返回文件或图片

3. 系统配置
- 触发：`GET /sys/config/public/info`
- 处理：读取 ASR/TTS 配置 → 解析可用音色
- 结果：返回系统配置

4. 模型与平台
- 触发：`GET /model/llms` / `/imageModels` / `/platforms`
- 处理：读取已配置模型/平台信息
- 结果：返回模型/平台列表（敏感字段脱敏）

## MCP（工具市场）
1. 公开 MCP 搜索与查询
- 触发：`GET /mcp/public/search` / `/public/list`
- 处理：搜索与批量查询 MCP
- 结果：返回 MCP 列表

2. 用户启用的 MCP
- 触发：`GET /user/mcp/list`
- 处理：查询当前用户启用的 MCP
- 结果：返回列表
- 触发：`POST /user/mcp/saveOrUpdate`
- 处理：保存/更新用户 MCP 配置
- 结果：返回更新后的 MCP 信息
