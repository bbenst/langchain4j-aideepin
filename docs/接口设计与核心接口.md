# 接口设计与核心接口

本文整理自当前会话问答，范围覆盖“核心接口清单”到“基于 Service 层复杂度的排序与结论”。

## 一、核心接口清单（按模块归类）

### 用户侧（adi-chat）

- 认证与用户：`/auth`、`/user`
- 会话与消息：`/conversation`、`/conversation/message`
- 知识库体系：`/knowledge-base`、`/knowledge-base-item`、`/knowledge-base/qa/`、`/knowledge-base-embedding`、`/knowledge-base-graph`、`/knowledge-base/star`
- 工作流：`/workflow`、`/workflow/runtime`
- 模型与平台：`/model`
- MCP：`/mcp`、`/user/mcp`
- 检索与记录：`/ai-search/`、`/ai-search-record/`
- 绘图能力：`/draw`、`/draw/comment`、`/draw/star`
- 提示词：`/prompt`
- 文件服务：`/file`（含文件/图片上传与读取）
- 系统配置：`/sys/config`
- 会话预设：`/conversation-preset`、`/conversation-preset-rel`

### 管理侧（adi-admin）

- 用户管理：`/admin/user`
- 会话管理：`/admin/conv`、`/admin/conv-preset`
- 模型与平台：`/admin/model`、`/admin/model-platform/`
- 知识库管理：`/admin/kb`
- 工作流与组件：`/admin/workflow`、`/admin/workflow/component`
- MCP 管理：`/admin/mcp`
- 系统配置：`/admin/sys-config`
- 统计：`/admin/statistic`

## 二、业务核心接口精选（5-10 个）

以下为“对话 / 知识库 / 工作流”链路的核心接口与用途：

1. `GET /conversation/list`
用途：获取当前用户对话列表。

2. `POST /conversation/add`
用途：新建对话。

3. `POST /conversation/message/process`
用途：发送提问并以 SSE 流式返回模型输出。

4. `GET /conversation/{uuid}`
用途：查询对话消息列表（支持游标分页）。

5. `POST /knowledge-base/uploadDocs/{uuid}`
用途：批量上传知识库文档并可选立即索引。

6. `POST /knowledge-base/indexing/{uuid}`
用途：对知识库执行索引（向量化/图谱化）。

7. `GET /knowledge-base/mine/search`
用途：搜索当前用户的知识库。

8. `POST /knowledge-base/qa/process/{qaRecordUuid}`
用途：知识库问答的 SSE 流式响应。

9. `POST /workflow/run/{wfUuid}`
用途：以 SSE 流式运行工作流。

## 三、基于 Service 层调用链与复杂度的排序（高到低）

1. `POST /conversation/message/process`
对应服务：`ConversationMessageService`
复杂度要点：SSE、配额与并发校验、语音转文本、RAG 并发检索、MCP 注入、提示词重构、音频生成与文件入库、引用记录、成本统计、长期记忆写入。

2. `POST /knowledge-base/qa/process/{qaRecordUuid}`
对应服务：`KnowledgeBaseService`
复杂度要点：SSE、问答限额、Token 估算、严格/宽松模式分支、RAG 召回、多模型参数、引用记录、成本统计。

3. `POST /workflow/run/{wfUuid}`
对应服务：`WorkflowStarter`、`WorkflowEngine`
复杂度要点：工作流组件/节点/边装载、运行时记录、执行编排与恢复、SSE 推送。

4. `POST /knowledge-base/uploadDocs/{uuid}`
对应服务：`KnowledgeBaseService`
复杂度要点：批量文件上传、文档解析、知识点生成、异常容错、可选索引触发、文件访问 URL 处理。

5. `POST /knowledge-base/indexing/{uuid}`（或 `POST /knowledge-base/item/indexing-list`）
对应服务：`KnowledgeBaseService`
复杂度要点：Redis 索引锁、批量异步索引、索引状态检测。

6. `POST /workflow/update`（或 `POST /workflow/copy/{wfUuid}`）
对应服务：`WorkflowService`
复杂度要点：节点/连线增删改、UUID 映射、引用关系重写、批量更新与事务一致性。

## 四、接口复杂度结论

- 复杂度最高的接口集中在“流式输出 + 异步处理 + RAG 检索 + 多服务协作”的链路上，典型代表是“对话消息处理”与“知识库问答”。
- 工作流运行接口在执行编排与运行时管理上复杂度很高，但其复杂度更多集中在引擎层与运行时持久化上。
- 知识库上传与索引接口属于“数据入口 + 异步索引”型复杂度，主要风险点在解析失败、索引冲突与任务状态管理。
